<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ Juego Turing (Sockets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
         body { font-family: 'Comic Neue', cursive; }
         .feedback-positivo { color: #16a34a; } .feedback-negativo { color: #dc2626; } button:disabled { opacity: 0.6; cursor: not-allowed; }
         iframe { margin: 1.5rem auto; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: block; max-width: 90%;}
          input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 to-blue-200 text-center p-6">
    <h1 class="text-4xl font-bold text-gray-800 mb-4">âš™ï¸ Juego Turing (Placeholder)</h1>
     <div class="flex justify-center items-center gap-4 mb-4">
          <img id="mascota-juego" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" alt="Mascota" class="w-20 h-20 animate-bounce">
          <div> <p id="jugador-actual" class="text-lg font-bold text-purple-800">Cargando...</p> <p id="mensaje-mascota" class="text-md text-purple-600 font-semibold">Â¡Piensa y responde!</p> </div>
      </div>
      <div id="estado-jugadores" class="text-sm text-gray-600 mb-4 h-6"></div>
    <div id="juego-area" class="bg-white max-w-xl mx-auto p-6 rounded-xl shadow mb-6 opacity-50 transition-opacity duration-500">
        <p class="text-lg text-gray-700">Nivel (Turing): <span id="nivel" class="font-bold">?</span> | Aciertos Totales: <span id="aciertos" class="font-bold">?</span></p>
        <div id="enunciado" class="text-2xl font-bold my-6 text-gray-700 min-h-[4rem]">Tarea: ...</div>
        <input type="text" id="respuesta-turing" class="text-center text-xl p-2 border border-gray-400 rounded w-64 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-50 disabled:bg-gray-100" placeholder="Escribe aquÃ­" disabled>
        <button onclick="enviarRespuestaTuring()" id="btn-validar-turing" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded transition disabled:opacity-50" disabled>Enviar</button>
         <div id="feedback" class="text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center"> <span id="feedback-text"></span> </div>
    </div>
    <div class="mt-8 space-x-4"> <button id="btn-salir" onclick="salirDelJuego()" class="bg-red-500 hover:bg-red-700 text-white px-5 py-2 rounded-full shadow transition transform hover:scale-105 disabled:opacity-50" disabled>ğŸšª Salir</button> <a href="../menu.html" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2.5 rounded-full inline-block">ğŸ”™ Volver al MenÃº</a> </div>
     <audio id="sonido-acierto" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
     <audio id="sonido-error" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
     <audio id="sonido-nivel" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>
<script>
    const SOCKET_URL = "http://localhost:3001"; const localUserId = parseInt(localStorage.getItem("usuarioActivo")); const urlParams = new URLSearchParams(window.location.search); const gameInstanceId = urlParams.get('gameId'); const gameType = 'turing'; let socket; let miNombre = ''; let miMascota = ''; let objetivoActual = ''; let inputDeshabilitado = false; let nivelActualLocal = 1; const jugadorActualEl = document.getElementById('jugador-actual'); const estadoJugadoresEl = document.getElementById('estado-jugadores'); const mascotaJuegoEl = document.getElementById('mascota-juego'); const mensajeMascotaEl = document.getElementById('mensaje-mascota'); const juegoAreaEl = document.getElementById('juego-area'); const nivelEl = document.getElementById('nivel'); const aciertosEl = document.getElementById('aciertos'); const enunciadoEl = document.getElementById('enunciado'); const respuestaInput = document.getElementById('respuesta-turing'); const btnValidar = document.getElementById('btn-validar-turing'); const feedbackTextEl = document.getElementById('feedback-text'); const btnSalirEl = document.getElementById('btn-salir'); const sonidoAcierto = document.getElementById('sonido-acierto'); const sonidoError = document.getElementById('sonido-error'); const sonidoNivel = document.getElementById('sonido-nivel'); const frasesMascota = { "Perro": "Â¡DesafÃ­o listo! ğŸ¶", "Gato": "Â¡A pensar! ğŸ±", "Tortuga": "Â¡TÃ³mate tu tiempo! ğŸ¢", "Elefante": "Â¡Demuestra tu lÃ³gica! ğŸ˜" }; const imagenesMascotas = { "Perro": "https://cdn-icons-png.flaticon.com/512/616/616408.png", "Gato": "https://cdn-icons-png.flaticon.com/512/616/616430.png", "Tortuga": "https://cdn-icons-png.flaticon.com/512/1998/1998611.png", "Elefante": "https://cdn-icons-png.flaticon.com/512/616/6164089.png"};
    function hablar(texto) { if (!texto || typeof speechSynthesis === 'undefined') return; try { speechSynthesis.cancel(); const voz = new SpeechSynthesisUtterance(texto); voz.lang = 'es-ES'; voz.rate = 1.1; speechSynthesis.speak(voz); } catch(e){ console.error("Speech error:", e); } }
    function actualizarMensajeMascota(tipo, textoAdicional = '') { let mensajeBase = frasesMascota[miMascota] || "Â¡Sigue asÃ­!"; if (mensajeMascotaEl) mensajeMascotaEl.innerText = mensajeBase + " " + textoAdicional; }
    function actualizarUIJugadores(playersData) { let jugadoresHtml = 'Jugando: '; let foundMe = false; let myTotalAciertos = '?'; if(!playersData || playersData.length === 0) { if(estadoJugadoresEl) estadoJugadoresEl.innerText = 'Esperando jugadores...'; return; } playersData.forEach(p => { const nivelToShow = (p.nivel !== undefined && p.nivel !== null) ? p.nivel : '?'; jugadoresHtml += `${p.nombre}(N${nivelToShow})${p.userId === localUserId ? 'â­' : ''}, `; if (p.userId === localUserId) { foundMe = true; miNombre = p.nombre; miMascota = p.mascota; nivelActualLocal = p.nivel; myTotalAciertos = p.totalAciertosUser !== undefined ? p.totalAciertosUser : (p.userData?.total_aciertos !== undefined ? p.userData.total_aciertos : '?'); if(jugadorActualEl) jugadorActualEl.innerText = `Â¡Vamos ${miNombre}!`; if(nivelEl) nivelEl.innerText = nivelToShow; if(aciertosEl) aciertosEl.innerText = myTotalAciertos; try{ if(mascotaJuegoEl) mascotaJuegoEl.src = imagenesMascotas[p.mascota] || imagenesMascotas['Perro']; } catch(e){console.error("Error setting mascot image", e)} } }); if (!foundMe) { if(jugadorActualEl) jugadorActualEl.innerText = "Esperando..."; } if(estadoJugadoresEl) estadoJugadoresEl.innerText = jugadoresHtml.slice(0, -2); if(juegoAreaEl) juegoAreaEl.style.opacity = 1; if(btnSalirEl) btnSalirEl.disabled = false; }
    function mostrarFeedbackVisual(esCorrecto, textoExpected = null) { let textoPrevio = feedbackTextEl?.textContent || ''; let mensajePrincipal = esCorrecto ? `âœ… Â¡Correcto!` : `âŒ Â¡Ups!`; if (!esCorrecto && textoExpected) { mensajePrincipal += ` Era "${textoExpected}".`; } if(feedbackTextEl) { feedbackTextEl.textContent = `${mensajePrincipal} ${textoPrevio}`; feedbackTextEl.className = `text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center ${esCorrecto ? 'feedback-positivo' : 'feedback-negativo'}`; } setInputEstado(false); }
    function setInputEstado(habilitado) { inputDeshabilitado = !habilitado; if(respuestaInput) respuestaInput.disabled = !habilitado; if(btnValidar) btnValidar.disabled = !habilitado; }
    function mostrarDesafioTuring(elemento, challengeData) { console.log("Mostrar Desafio (Turing):", elemento, challengeData); objetivoActual = elemento; if(enunciadoEl) enunciadoEl.textContent = challengeData?.instruction || `Escribe: ${elemento}`; if(respuestaInput) respuestaInput.value = ''; if(feedbackTextEl) { feedbackTextEl.textContent = ''; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center'; } setInputEstado(true); if(respuestaInput) respuestaInput.focus(); hablar(enunciadoEl.textContent || ''); }
    function limpiarTextoCliente(texto = '') { if(typeof texto !== 'string') texto = String(texto); return texto.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
    function enviarRespuestaTuring() { if (inputDeshabilitado || !socket || !socket.connected) { console.warn("enviarRespuestaTuring llamado sin conexiÃ³n o input deshabilitado."); return; } setInputEstado(false); const respuestaUsuario = respuestaInput.value; console.log(`Sending answer (Turing): ${respuestaUsuario}`); socket.emit('submitAnswer', { gameInstanceId: gameInstanceId, userId: localUserId, answer: respuestaUsuario }); if(feedbackTextEl) { feedbackTextEl.textContent = 'ğŸ¤” Comprobando...'; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center feedback-neutro';} }
    function salirDelJuego() { console.log("Intentando salir..."); if(btnSalirEl) btnSalirEl.disabled = true; if(btnSalirEl) btnSalirEl.innerText = "Saliendo..."; if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); } setTimeout(() => { window.location.href = '../menu.html'; }, 300); }
    function conectarSocket() { if (socket && socket.connected) return; if(jugadorActualEl) jugadorActualEl.innerText = "Conectando..."; socket = io(SOCKET_URL, { reconnectionAttempts: 3, timeout: 10000 }); socket.on("connect", () => { console.log("Socket Conectado:", socket.id); if(jugadorActualEl) jugadorActualEl.innerText = 'Conectado. Identificando...'; if (localUserId) { socket.emit("identify", localUserId); } else { console.error("localUserId no definido"); alert("Error: Falta ID usuario."); if(jugadorActualEl) jugadorActualEl.innerText = 'Error: Sin ID'; if(btnSalirEl) btnSalirEl.disabled = false;} }); socket.on("identified", () => { console.log("Identificado."); if(jugadorActualEl) jugadorActualEl.innerText = 'Identificado. UniÃ©ndose...'; socket.emit('joinGame', { gameInstanceId: gameInstanceId, userId: localUserId, gameType: gameType }); }); socket.on("disconnect", (reason) => { console.warn("Socket Desconectado:", reason); if(jugadorActualEl) jugadorActualEl.innerText = 'Desconectado.'; alert("Se perdiÃ³ la conexiÃ³n."); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; setInputEstado(false);}); socket.on("connect_error", (err) => { console.error("Error ConexiÃ³n Socket:", err.message); if(jugadorActualEl) jugadorActualEl.innerText = 'Error conexiÃ³n.'; alert(`No se pudo conectar: ${err.message}.`); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; setInputEstado(false);}); socket.on("serverError", (data) => { console.error("Error Servidor:", data.message); alert(`Error: ${data.message}`); setInputEstado(true); }); socket.on("gameStateUpdate", (data) => { console.log("Recibido gameStateUpdate:", data); try { actualizarUIJugadores(data.players || []); } catch(e) { console.error("Error updating UI players:", e)} }); socket.on("nextElement", (data) => { console.log("Recibido nextElement (Turing):", data); try { if (data && data.element !== undefined) { mostrarDesafioTuring(data.element, data.challengeData); } else { if(enunciadoEl) enunciadoEl.textContent = "Esperando desafÃ­o..."; if(respuestaInput) respuestaInput.value=''; setInputEstado(false); console.warn("Datos de nextElement incompletos:", data); } } catch (e) { console.error("Error procesando nextElement:", e); if(enunciadoEl) enunciadoEl.textContent = "Error al cargar"; } }); socket.on("feedbackUpdate", (data) => { console.log("Recibido feedbackUpdate:", data); let feedbackMsg = ''; if (data.nivelCambiado) { try { if(sonidoNivel) sonidoNivel.play().catch(e=>{console.warn("Sound error",e)}); } catch(e){} feedbackMsg = `Â¡Nivel ${data.nuevoNivel}! `; if(nivelEl) nivelEl.innerText = data.nuevoNivel; } if (data.type >= 0.8) feedbackMsg += "ğŸš€ Â¡Genial!"; else if (data.type >= 0.4) feedbackMsg += "ğŸ‘ Â¡Bien!"; else feedbackMsg += "ğŸ’ª Â¡Ãnimo!"; if(feedbackTextEl) feedbackTextEl.textContent = feedbackMsg; actualizarMensajeMascota(data.type, data.nivelCambiado ? `Â¡Nivel ${data.nuevoNivel}!` : ''); }); socket.on("answerResult", (data) => { console.log("Recibido answerResult:", data); if (data.userId === localUserId) { const esCorrectoServer = data.correct; mostrarFeedbackVisual(esCorrectoServer, data.expected); try { if (esCorrectoServer) { if(sonidoAcierto) sonidoAcierto.play().catch(e=>{console.warn("Sound error",e)}); } else { if(sonidoError) sonidoError.play().catch(e=>{console.warn("Sound error",e)}); } } catch(e){} if(aciertosEl) aciertosEl.innerText = data.totalAciertosUser !== undefined ? data.totalAciertosUser : '?'; } else { console.log(`Jugador ${data.userId} respondiÃ³.`); } }); socket.on("playerLeft", (data) => { console.log(`Jugador ${data.userId} saliÃ³.`); if(estadoJugadoresEl) estadoJugadoresEl.innerText += ` (${data.userId} saliÃ³)`; }); socket.on("gameOver", (data) => { console.log("Game Over:", data.message); if(enunciadoEl) enunciadoEl.textContent = "Â¡Juego Terminado!"; if(respuestaInput) respuestaInput.value=''; setInputEstado(false); if(feedbackTextEl) feedbackTextEl.textContent = data.message || 'Â¡Muy bien!'; try { hablar(data.message || "Juego terminado"); } catch(e){} }); }
    window.addEventListener('load', () => { if (!localUserId) { alert("Perfil no seleccionado. Volviendo inicio."); window.location.href = '../index.html'; return; } if (!gameInstanceId) { alert("Falta ID juego. Volviendo menÃº."); window.location.href = '../menu.html'; return; } if (!jugadorActualEl || !enunciadoEl || !respuestaInput || !btnValidar || !feedbackTextEl || !btnSalirEl || !mascotaJuegoEl || !mensajeMascotaEl || !juegoAreaEl || !nivelEl || !aciertosEl || !estadoJugadoresEl || !sonidoAcierto || !sonidoError || !sonidoNivel ) { console.error("Error crÃ­tico: Faltan elementos HTML esenciales."); alert("Error al cargar la interfaz del juego."); return; } conectarSocket(); }); window.addEventListener('beforeunload', () => { if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); socket.disconnect(); } });
    if(respuestaInput) respuestaInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !inputDeshabilitado) { enviarRespuestaTuring(); } });
</script>

</body>
</html>