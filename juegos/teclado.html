<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>‚å®Ô∏è Juego de Teclado (Sockets)</title> <script src="https://cdn.tailwindcss.com"></script> <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet"> <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style> body { font-family: 'Comic Neue', cursive; } input.correcto { border: 3px solid #16a34a !important; background-color: #f0fdf4; } input.incorrecto { border: 3px solid #dc2626 !important; background-color: #fef2f2; } .feedback-positivo { color: #16a34a; } .feedback-negativo { color: #dc2626; } button:disabled { opacity: 0.6; cursor: not-allowed; } iframe { margin: 1.5rem auto; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: block; max-width: 90%; } input:disabled { background-color: #f3f4f6; cursor: not-allowed; } </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-100 to-rose-200 text-center p-6">
    <h1 class="text-4xl font-bold text-pink-800 mb-4">‚å®Ô∏è Juego de Teclado</h1>
    <div class="flex justify-center items-center gap-4 mb-4"> <img id="mascota-juego" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" alt="Mascota" class="w-20 h-20 animate-bounce"> <div> <p id="jugador-actual" class="text-lg font-bold text-purple-800">Cargando...</p> <p id="mensaje-mascota" class="text-md text-purple-600 font-semibold">¬°Escribe con cuidado!</p> </div> </div> <div id="estado-jugadores" class="text-sm text-gray-600 mb-4 h-6"></div>
     <iframe width="320" height="240" src="https://www.youtube.com/embed/4laBhZHdK34" title="Video explicativo Teclado" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    <div id="juego-area" class="bg-white max-w-xl mx-auto p-6 rounded-xl shadow mb-6 opacity-50 transition-opacity duration-500">
         <p class="text-lg text-gray-700">Nivel (Teclado): <span id="nivel" class="font-bold">?</span> | Aciertos (Teclado): <span id="aciertos" class="font-bold">?</span></p>
         <div id="enunciado" class="text-3xl font-bold my-6 text-purple-800 min-h-[4rem]">Escribe: ...</div> <input type="text" id="respuesta" class="text-center text-2xl p-3 border-2 border-gray-300 rounded-lg w-64 md:w-80 transition-all focus:outline-none focus:ring-2 focus:ring-pink-400 disabled:opacity-50 disabled:bg-gray-100" placeholder="Tu respuesta..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled> <div class="mt-4"> <button onclick="verificarRespuesta()" id="btn-validar" class="bg-pink-500 hover:bg-pink-600 text-white px-8 py-3 rounded-full text-lg transform transition hover:scale-105 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-opacity-50 disabled:opacity-50" disabled>Validar</button> </div> <div id="feedback" class="text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center"> <span id="feedback-text"></span> </div> </div>
    <div class="mt-8 space-x-4"> <button id="btn-salir" onclick="salirDelJuego()" class="bg-red-500 hover:bg-red-700 text-white px-5 py-2 rounded-full shadow transition transform hover:scale-105 disabled:opacity-50" disabled>üö™ Salir</button> <a href="../menu.html" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2.5 rounded-full inline-block">üîô Volver al Men√∫</a> </div>
    <audio id="sonido-acierto" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio> <audio id="sonido-error" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio> <audio id="sonido-nivel" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio> <audio id="sonido-tecla" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>
<script>
    const SOCKET_URL = "http://localhost:3001"; const localUserId = parseInt(localStorage.getItem("usuarioActivo")); const urlParams = new URLSearchParams(window.location.search); const gameInstanceId = urlParams.get('gameId'); const gameType = 'teclado'; let socket; let miNombre = ''; let miMascota = ''; let objetivoActual = ''; let inputDeshabilitado = false; let nivelActualLocal = 1; let aciertosJuegoLocal = 0; const jugadorActualEl = document.getElementById('jugador-actual'); const estadoJugadoresEl = document.getElementById('estado-jugadores'); const mascotaJuegoEl = document.getElementById('mascota-juego'); const mensajeMascotaEl = document.getElementById('mensaje-mascota'); const juegoAreaEl = document.getElementById('juego-area'); const nivelEl = document.getElementById('nivel'); const aciertosEl = document.getElementById('aciertos'); const enunciadoEl = document.getElementById('enunciado'); const respuestaInput = document.getElementById('respuesta'); const btnValidar = document.getElementById('btn-validar'); const feedbackTextEl = document.getElementById('feedback-text'); const btnSalirEl = document.getElementById('btn-salir'); const sonidoAcierto = document.getElementById('sonido-acierto'); const sonidoError = document.getElementById('sonido-error'); const sonidoNivel = document.getElementById('sonido-nivel'); const sonidoTecla = document.getElementById('sonido-tecla'); const frasesMascota = { "Perro": "¬°Escribe r√°pido! üê∂", "Gato": "¬°Atento al teclado! üê±", "Tortuga": "¬°Letra a letra! üê¢", "Elefante": "¬°Concentraci√≥n! üêò" }; const imagenesMascotas = { "Perro": "https://cdn-icons-png.flaticon.com/512/616/616408.png", "Gato": "https://cdn-icons-png.flaticon.com/512/616/616430.png", "Tortuga": "https://cdn-icons-png.flaticon.com/512/1998/1998611.png", "Elefante": "https://cdn-icons-png.flaticon.com/512/616/6164089.png"};
    function hablar(texto) { if (!texto || typeof speechSynthesis === 'undefined') return; try { speechSynthesis.cancel(); const voz = new SpeechSynthesisUtterance(texto); voz.lang = 'es-ES'; voz.rate = 1.1; speechSynthesis.speak(voz); } catch(e){ console.error("Speech error:", e); } }
    function actualizarMensajeMascota(tipo, textoAdicional = '') { let mensajeBase = frasesMascota[miMascota] || "¬°Sigue as√≠!"; if (mensajeMascotaEl) mensajeMascotaEl.innerText = mensajeBase + " " + textoAdicional; }
    function actualizarUIJugadores(playersData) { let jugadoresHtml = 'Jugando: '; let foundMe = false; if(!playersData || playersData.length === 0) { if(estadoJugadoresEl) estadoJugadoresEl.innerText = 'Esperando jugadores...'; return; } playersData.forEach(p => { const nivelToShow = (p.nivel !== undefined && p.nivel !== null) ? p.nivel : '?'; const aciertosToShow = (p.totalAciertosJuego !== undefined && p.totalAciertosJuego !== null) ? p.totalAciertosJuego : '?'; jugadoresHtml += `${p.nombre}(N${nivelToShow})${p.userId === localUserId ? '‚≠ê' : ''}, `; if (p.userId === localUserId) { foundMe = true; miNombre = p.nombre; miMascota = p.mascota; nivelActualLocal = nivelToShow; aciertosJuegoLocal = aciertosToShow; if(jugadorActualEl) jugadorActualEl.innerText = `¬°Vamos ${miNombre}!`; if(nivelEl) nivelEl.innerText = nivelToShow; if(aciertosEl) aciertosEl.innerText = aciertosToShow; // ** USA ACIERTOS DEL JUEGO **
         try{ if(mascotaJuegoEl) mascotaJuegoEl.src = imagenesMascotas[p.mascota] || imagenesMascotas['Perro']; } catch(e){console.error("Err mascot", e)} } }); if (!foundMe) { if(jugadorActualEl) jugadorActualEl.innerText = "Esperando..."; } if(estadoJugadoresEl) estadoJugadoresEl.innerText = jugadoresHtml.slice(0, -2); if(juegoAreaEl) juegoAreaEl.style.opacity = 1; if(btnSalirEl) btnSalirEl.disabled = false; }
    function mostrarFeedbackVisual(esCorrecto, textoExpected = null) { let textoPrevio = feedbackTextEl?.textContent || ''; let mensajePrincipal = esCorrecto ? `‚úÖ ¬°Correcto!` : `‚ùå ¬°Ups!`; if (!esCorrecto && textoExpected) { mensajePrincipal += ` Era "${textoExpected}".`; } if(feedbackTextEl) { feedbackTextEl.textContent = `${mensajePrincipal} ${textoPrevio}`; feedbackTextEl.className = `text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center ${esCorrecto ? 'feedback-positivo' : 'feedback-negativo'}`; } if(respuestaInput) { respuestaInput.classList.remove('correcto', 'incorrecto'); respuestaInput.classList.add(esCorrecto ? 'correcto' : 'incorrecto'); } setInputEstado(false); }
    function setInputEstado(habilitado) { inputDeshabilitado = !habilitado; if(respuestaInput) respuestaInput.disabled = !habilitado; if(btnValidar) btnValidar.disabled = !habilitado; }
    function mostrarDesafioTeclado(elemento) { console.log("Mostrar Desafio (Teclado):", elemento); objetivoActual = elemento; if(enunciadoEl) enunciadoEl.textContent = `Escribe: ${elemento}`; if(respuestaInput) { respuestaInput.value = ''; respuestaInput.classList.remove('correcto', 'incorrecto'); } if(feedbackTextEl) { feedbackTextEl.textContent = ''; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center'; } setInputEstado(true); if(respuestaInput) respuestaInput.focus(); hablar(`Escribe ${elemento}`); }
    function limpiarTextoCliente(texto = '') { if(typeof texto !== 'string') texto = String(texto); return texto.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
    function verificarRespuesta() { if (inputDeshabilitado || !socket || !socket.connected) { console.warn("Verificar llamado sin conexi√≥n o input deshabilitado."); return; } setInputEstado(false); const respuestaUsuario = respuestaInput.value; console.log(`Sending answer (Teclado): ${respuestaUsuario}`); socket.emit('submitAnswer', { gameInstanceId: gameInstanceId, userId: localUserId, answer: respuestaUsuario }); if(feedbackTextEl) { feedbackTextEl.textContent = 'ü§î Comprobando...'; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center feedback-neutro';} }
    function salirDelJuego() { console.log("Intentando salir..."); if(btnSalirEl) btnSalirEl.disabled = true; if(btnSalirEl) btnSalirEl.innerText = "Saliendo..."; if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); } setTimeout(() => { window.location.href = '../menu.html'; }, 300); }
    function conectarSocket() { if (socket && socket.connected) return; if(jugadorActualEl) jugadorActualEl.innerText = "Conectando..."; socket = io(SOCKET_URL, { reconnectionAttempts: 3, timeout: 10000 }); socket.on("connect", () => { console.log("Socket Conectado:", socket.id); if(jugadorActualEl) jugadorActualEl.innerText = 'Conectado. Identificando...'; if (localUserId) { socket.emit("identify", localUserId); } else { console.error("localUserId no def"); alert("Error: Falta ID usr."); if(jugadorActualEl) jugadorActualEl.innerText = 'Error: Sin ID'; if(btnSalirEl) btnSalirEl.disabled = false; } }); socket.on("identified", () => { console.log("Identificado."); if(jugadorActualEl) jugadorActualEl.innerText = 'Identificado. Uni√©ndose...'; socket.emit('joinGame', { gameInstanceId: gameInstanceId, userId: localUserId, gameType: gameType }); }); socket.on("disconnect", (reason) => { console.warn("Socket Desc:", reason); if(jugadorActualEl) jugadorActualEl.innerText = 'Desconectado.'; alert("Se perdi√≥ conexi√≥n."); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; setInputEstado(false);}); socket.on("connect_error", (err) => { console.error("Error Conex Socket:", err.message); if(jugadorActualEl) jugadorActualEl.innerText = 'Error conexi√≥n.'; alert(`No se pudo conectar: ${err.message}.`); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; setInputEstado(false);}); socket.on("serverError", (data) => { console.error("Error Servidor:", data.message); alert(`Error: ${data.message}`); setInputEstado(true); }); socket.on("gameStateUpdate", (data) => { console.log("Rec gameStateUpdate:", data); try { actualizarUIJugadores(data.players || []); } catch(e) { console.error("Error update UI:", e)} }); socket.on("nextElement", (data) => { console.log("Rec nextElement (Teclado):", data); try { if (data && data.element !== undefined) { mostrarDesafioTeclado(data.element); } else { if(enunciadoEl) enunciadoEl.textContent = "Esperando desaf√≠o..."; if(respuestaInput) respuestaInput.value=''; setInputEstado(false); console.warn("Datos nextElement inc:", data); } } catch (e) { console.error("Error proc nextElement:", e); if(enunciadoEl) enunciadoEl.textContent = "Error al cargar"; } }); socket.on("feedbackUpdate", (data) => { console.log("Rec feedbackUpdate:", data); let feedbackMsg = ''; if (data.nivelCambiado) { try { if(sonidoNivel) sonidoNivel.play().catch(e=>{}); } catch(e){} feedbackMsg = `¬°Nivel ${data.nuevoNivel}! `; if(nivelEl) nivelEl.innerText = data.nuevoNivel; } if (data.type >= 0.8) feedbackMsg += "üöÄ Genial!"; else if (data.type >= 0.4) feedbackMsg += "üëç Bien!"; else feedbackMsg += "üí™ √Ånimo!"; if(feedbackTextEl) feedbackTextEl.textContent = feedbackMsg; actualizarMensajeMascota(data.type, data.nivelCambiado ? `¬°Nivel ${data.nuevoNivel}!` : ''); }); socket.on("answerResult", (data) => { console.log("Rec answerResult:", data); if (data.userId === localUserId) { const esCorrecto = data.correct; mostrarFeedbackVisual(esCorrecto, data.expected); try { if(esCorrecto){ if(sonidoAcierto) sonidoAcierto.play().catch(e=>{});} else { if(sonidoError) sonidoError.play().catch(e=>{});} } catch(e){} if(aciertosEl) aciertosEl.innerText = data.totalAciertosJuego !== undefined ? data.totalAciertosJuego : '?'; // ** USA ACIERTOS DEL JUEGO **
        } else { console.log(`Jugador ${data.userId} respondi√≥.`); } }); socket.on("playerLeft", (data) => { console.log(`Jugador ${data.userId} sali√≥.`); if(estadoJugadoresEl) estadoJugadoresEl.innerText += ` (${data.userId} sali√≥)`; }); socket.on("gameOver", (data) => { console.log("Game Over:", data.message); if(enunciadoEl) enunciadoEl.textContent = "¬°Juego Terminado!"; if(respuestaInput) respuestaInput.value=''; setInputEstado(false); if(feedbackTextEl) feedbackTextEl.textContent = data.message || '¬°Muy bien!'; try { hablar(data.message || "Juego terminado"); } catch(e){} }); }
    window.addEventListener('load', () => { if (!localUserId) { alert("Perfil no seleccionado. Volviendo inicio."); window.location.href = '../index.html'; return; } if (!gameInstanceId) { alert("Falta ID juego. Volviendo men√∫."); window.location.href = '../menu.html'; return; } if (!jugadorActualEl || !enunciadoEl || !respuestaInput || !btnValidar || !feedbackTextEl || !btnSalirEl || !mascotaJuegoEl || !mensajeMascotaEl || !juegoAreaEl || !nivelEl || !aciertosEl || !estadoJugadoresEl || !sonidoAcierto || !sonidoError || !sonidoNivel || !sonidoTecla ) { console.error("Error cr√≠tico: Faltan elementos HTML esenciales."); alert("Error al cargar la interfaz del juego."); return; } conectarSocket(); }); window.addEventListener('beforeunload', () => { if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); socket.disconnect(); } });
    if(respuestaInput) respuestaInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !inputDeshabilitado) { verificarRespuesta(); } });
    if(respuestaInput) respuestaInput.addEventListener('input', () => { try { if(sonidoTecla && sonidoTecla.readyState >= 2) sonidoTecla.play().catch(e=>{}); } catch(e){} });
</script>
</body>
</html>