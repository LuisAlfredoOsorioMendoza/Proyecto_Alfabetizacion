<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <title>🎤 Juego de Voz (Sockets)</title> <script src="https://cdn.tailwindcss.com"></script> <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet"> <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style> body { font-family: 'Comic Neue', cursive; } .feedback-positivo { color: #16a34a; } .feedback-negativo { color: #dc2626; } button:disabled { opacity: 0.6; cursor: not-allowed; } #mic-button.recording { animation: pulse 1.5s infinite; background-color: #f59e0b; } #mic-button.recording:hover { background-color: #d97706; } @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } } iframe { margin: 1.5rem auto; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: block; max-width: 90%; } </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-cyan-200 text-center p-6">
    <h1 class="text-4xl font-bold text-blue-800 mb-4">🎤 Juego de Voz</h1>
    <div class="flex justify-center items-center gap-4 mb-4"> <img id="mascota-juego" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" alt="Mascota" class="w-20 h-20 animate-bounce"> <div> <p id="jugador-actual" class="text-lg font-bold text-purple-800">Cargando...</p> <p id="mensaje-mascota" class="text-md text-purple-600 font-semibold">¡Di lo que ves!</p> </div> </div> <div id="estado-jugadores" class="text-sm text-gray-600 mb-4 h-6"></div>
    <iframe width="320" height="240" src="https://www.youtube.com/embed/cbgM9BYWT9E" title="Repite las palabras" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen> </iframe>
    <div id="juego-area" class="bg-white max-w-xl mx-auto p-6 rounded-xl shadow mb-6 opacity-50 transition-opacity duration-500">
         <p class="text-lg text-gray-700">Nivel (Voz): <span id="nivel" class="font-bold">?</span> | Aciertos (Voz): <span id="aciertos" class="font-bold">?</span></p>
         <p class="text-3xl font-bold my-6 text-purple-700 min-h-[4rem]" id="palabra-a-decir">Di: ...</p>
         <button id="mic-button" onclick="toggleReconocimiento()" class="bg-red-500 text-white px-6 py-3 rounded-full mb-4 hover:bg-red-600 transition text-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50" disabled>🎤 Permiso...</button>
         <p id="resultado-voz" class="text-lg text-gray-700 mb-2 min-h-[2rem]">Tu dijiste: ---</p>
         <div id="feedback" class="text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center"> <span id="feedback-text"></span> </div>
    </div>
    <div class="mt-8 space-x-4"> <button id="btn-salir" onclick="salirDelJuego()" class="bg-red-500 hover:bg-red-700 text-white px-5 py-2 rounded-full shadow transition transform hover:scale-105 disabled:opacity-50" disabled>🚪 Salir</button> <a href="../menu.html" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2.5 rounded-full inline-block">🔙 Volver al Menú</a> </div>
    <audio id="sonido-acierto" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio> <audio id="sonido-error" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio> <audio id="sonido-nivel" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio> <audio id="sonido-mic-on" src="https://www.soundjay.com/button/sounds/button-7.mp3" preload="auto"></audio> <audio id="sonido-mic-off" src="https://www.soundjay.com/button/sounds/button-6.mp3" preload="auto"></audio>
<script>
    const SOCKET_URL = "http://localhost:3001"; const localUserId = parseInt(localStorage.getItem("usuarioActivo")); const urlParams = new URLSearchParams(window.location.search); const gameInstanceId = urlParams.get('gameId'); const gameType = 'voz'; let socket; let miNombre = ''; let miMascota = ''; let objetivoActual = ""; let reconocimiento; let escuchando = false; const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let micPermisoConcedido = false; let nivelActualLocal = 1; let aciertosJuegoLocal = 0; const jugadorActualEl = document.getElementById('jugador-actual'); const estadoJugadoresEl = document.getElementById('estado-jugadores'); const mascotaJuegoEl = document.getElementById('mascota-juego'); const mensajeMascotaEl = document.getElementById('mensaje-mascota'); const juegoAreaEl = document.getElementById('juego-area'); const nivelEl = document.getElementById('nivel'); const aciertosEl = document.getElementById('aciertos'); const palabraADecirEl = document.getElementById('palabra-a-decir'); const micButton = document.getElementById('mic-button'); const resultadoVozEl = document.getElementById('resultado-voz'); const feedbackTextEl = document.getElementById('feedback-text'); const btnSalirEl = document.getElementById('btn-salir'); const sonidoAcierto = document.getElementById('sonido-acierto'); const sonidoError = document.getElementById('sonido-error'); const sonidoNivel = document.getElementById('sonido-nivel'); const sonidoMicOn = document.getElementById('sonido-mic-on'); const sonidoMicOff = document.getElementById('sonido-mic-off'); const frasesMascota = { "Perro": "¡Habla fuerte y claro! 🐶", "Gato": "¡Te escucho! 🐱", "Tortuga": "¡Despacio! 🐢", "Elefante": "¡Con fuerza! 🐘" }; const imagenesMascotas = { "Perro": "https://cdn-icons-png.flaticon.com/512/616/616408.png", "Gato": "https://cdn-icons-png.flaticon.com/512/616/616430.png", "Tortuga": "https://cdn-icons-png.flaticon.com/512/1998/1998611.png", "Elefante": "https://cdn-icons-png.flaticon.com/512/616/6164089.png"};
    const ejemplosLetras = { A: "Avión", B: "Barco", C: "Casa", D: "Dado", E: "Elefante", F: "Foca", G: "Gato", H: "Hoja", I: "Iglesia", J: "Jirafa", K: "Koala", L: "Luna", M: "Mano", N: "Nube", Ñ: "Ñandú", O: "Oso", P: "Perro", Q: "Queso", R: "Ratón", S: "Sol", T: "Taza", U: "Uva", V: "Vaca", W: "Wafle", X: "Xilófono", Y: "Yoyo", Z: "Zapato" };
    function hablar(texto) { if (!texto || typeof speechSynthesis === 'undefined') return; try { speechSynthesis.cancel(); const voz = new SpeechSynthesisUtterance(texto); voz.lang = 'es-ES'; voz.rate = 1.1; speechSynthesis.speak(voz); } catch(e){ console.error("Speech error:", e); } }
    function actualizarMensajeMascota(tipo, textoAdicional = '') { let mensajeBase = frasesMascota[miMascota] || "¡Sigue así!"; if (mensajeMascotaEl) mensajeMascotaEl.innerText = mensajeBase + " " + textoAdicional; }
    function actualizarUIJugadores(playersData) { let jugadoresHtml = 'Jugando: '; let foundMe = false; if(!playersData || playersData.length === 0) { if(estadoJugadoresEl) estadoJugadoresEl.innerText = 'Esperando jugadores...'; return; } playersData.forEach(p => { const nivelToShow = (p.nivel !== undefined && p.nivel !== null) ? p.nivel : '?'; const aciertosToShow = (p.totalAciertosJuego !== undefined && p.totalAciertosJuego !== null) ? p.totalAciertosJuego : '?'; jugadoresHtml += `${p.nombre}(N${nivelToShow})${p.userId === localUserId ? '⭐' : ''}, `; if (p.userId === localUserId) { foundMe = true; miNombre = p.nombre; miMascota = p.mascota; nivelActualLocal = nivelToShow; aciertosJuegoLocal = aciertosToShow; if(jugadorActualEl) jugadorActualEl.innerText = `¡Vamos ${miNombre}!`; if(nivelEl) nivelEl.innerText = nivelToShow; if(aciertosEl) aciertosEl.innerText = aciertosToShow; // ** USA ACIERTOS DEL JUEGO **
         try{ if(mascotaJuegoEl) mascotaJuegoEl.src = imagenesMascotas[p.mascota] || imagenesMascotas['Perro']; } catch(e){console.error("Err mascot", e)} } }); if (!foundMe) { if(jugadorActualEl) jugadorActualEl.innerText = "Esperando..."; } if(estadoJugadoresEl) estadoJugadoresEl.innerText = jugadoresHtml.slice(0, -2); if(juegoAreaEl) juegoAreaEl.style.opacity = 1; if(btnSalirEl) btnSalirEl.disabled = false; }
    function mostrarFeedbackVisual(esCorrecto, textoExpected = null) { let textoPrevio = feedbackTextEl?.textContent || ''; let mensajePrincipal = esCorrecto ? `✅ ¡Correcto!` : `❌ ¡Ups!`; if (!esCorrecto && textoExpected) { mensajePrincipal += ` Era "${textoExpected}".`; } if(feedbackTextEl) { feedbackTextEl.textContent = `${mensajePrincipal} ${textoPrevio}`; feedbackTextEl.className = `text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center ${esCorrecto ? 'feedback-positivo' : 'feedback-negativo'}`; } if(micButton) micButton.disabled = true; }
    function setupSpeechRecognition() { if (!SpeechRecognition || reconocimiento) { return;} try { console.log("Setting up SR..."); reconocimiento = new SpeechRecognition(); reconocimiento.lang = "es-ES"; reconocimiento.continuous = false; reconocimiento.interimResults = false; reconocimiento.maxAlternatives = 1; reconocimiento.onstart = () => { console.log("Voz: onstart"); escuchando = true; if(micButton) { micButton.textContent = "👂 Escuchando..."; micButton.classList.add('recording', 'bg-yellow-500', 'hover:bg-yellow-600'); micButton.classList.remove('bg-red-500', 'hover:bg-red-600'); } try { if(sonidoMicOn) sonidoMicOn.play().catch(e=>{}); } catch(e){} if(resultadoVozEl) resultadoVozEl.textContent = 'Tu dijiste: ---'; if(feedbackTextEl) feedbackTextEl.textContent='';}; reconocimiento.onresult = (event) => { console.log("Voz: onresult"); let dicho = ''; if (event.results && event.results.length > 0) { const ultimo = event.results[event.results.length - 1]; if (ultimo.isFinal && ultimo[0]) { dicho = ultimo[0].transcript; } } if(dicho) { console.log("Voz: Result final:", dicho); if(resultadoVozEl) resultadoVozEl.textContent = `Tu dijiste: "${dicho}"`; stopRecognition(false); verificarRespuestaVoz(dicho); } else { console.warn("Resultado voz vacío/no final", event.results); }}; reconocimiento.onerror = (event) => { console.error("Voz Error:", event.error); let msg = `Error micrófono (${event.error}).`; let recoverable = false; if (event.error === 'no-speech') { msg = "No se detectó voz. ¡Habla más fuerte!"; recoverable = true; } else if (event.error === 'audio-capture') msg = "Problema capturando audio."; else if (event.error === 'not-allowed') { msg = "Permiso de micrófono denegado."; micPermisoConcedido = false; } else if (event.error === 'aborted') { msg = "Intento cancelado."; recoverable = true;} if(resultadoVozEl) resultadoVozEl.textContent = `Error: ${msg}`; if(feedbackTextEl && !recoverable) { feedbackTextEl.textContent = `⚠️ ${msg}`; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center feedback-negativo'; } stopRecognition(true); }; reconocimiento.onend = () => { console.log("Voz: onend"); if(escuchando){ stopRecognition(false); } }; } catch(e){ console.error("SR Init Fail:", e); micPermisoConcedido = false; if(micButton){ micButton.textContent="⛔ Error API"; micButton.disabled = true; } alert("Error al inicializar voz.");}}
    function startRecognition() { if (!reconocimiento || escuchando || !micPermisoConcedido) { console.warn(`Start Rec ignored: reco=${!!reconocimiento}, esc=${escuchando}, perm=${micPermisoConcedido}`); return;} try { console.log("Starting SR..."); reconocimiento.start(); } catch (e) { console.error("Error start mic:", e); if (e.name === 'InvalidStateError') { console.warn("SR already started or error state?"); } else { alert("No se pudo iniciar reconocimiento."); } stopRecognition(true); } }
    function stopRecognition(wasErrorOrManual=false) { if (reconocimiento && escuchando) { console.log(`Stopping SR... (Error/Manual: ${wasErrorOrManual})`); try { reconocimiento.stop(); } catch(e){console.warn("Error stop mic:", e);} } escuchando = false; if(micButton) { micButton.textContent = "🎤 ¡Habla Ahora!"; micButton.classList.remove('recording', 'bg-yellow-500', 'hover:bg-yellow-600'); micButton.classList.add('bg-red-500', 'hover:bg-red-600'); micButton.disabled = !micPermisoConcedido || !objetivoActual; } }
    async function pedirPermisoMic(){ if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { micPermisoConcedido = false; if(micButton){ micButton.textContent="⛔ API No Soportada"; micButton.disabled = true;} alert("Micrófono no soportado."); return false;} try { console.log("Pidiendo permiso mic..."); const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); console.log("Permiso mic OK."); micPermisoConcedido = true; if(micButton) { micButton.disabled = false; micButton.textContent = "🎤 ¡Habla Ahora!";} stream.getTracks().forEach(track => track.stop()); setupSpeechRecognition(); return true; } catch (err) { console.error("Error permiso mic:", err); micPermisoConcedido = false; if(micButton) { micButton.disabled = true; micButton.textContent = "⛔ Sin Permiso"; } alert("Necesitamos permiso para usar el micrófono."); return false; } }
    function toggleReconocimiento() { if (!micPermisoConcedido && SpeechRecognition) { pedirPermisoMic(); return; } if (!reconocimiento && micPermisoConcedido) { setupSpeechRecognition(); } if (!reconocimiento) { console.warn("Reco no init"); return;} if (escuchando) { stopRecognition(true); } else { startRecognition(); } }
    function mostrarDesafioVoz(elemento) { console.log("Mostrar Desafio (Voz):", elemento); objetivoActual = elemento; let textoParaMostrar = `Di: "${elemento}"`; let textoParaHablar = `Di ${elemento.length === 1 ? 'la letra' : 'la palabra'} ${elemento}`; const ejemplo = elemento.length === 1 ? ejemplosLetras[elemento.toUpperCase()] : null; if (ejemplo) { textoParaMostrar = `Di: "${elemento}" de ${ejemplo}`; textoParaHablar = `Di ${elemento} de ${ejemplo}`; } if(palabraADecirEl) palabraADecirEl.textContent = textoParaMostrar; if(resultadoVozEl) resultadoVozEl.textContent = 'Tu dijiste: ---'; if(feedbackTextEl) { feedbackTextEl.textContent = ''; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center'; } stopRecognition(true); if(micButton) micButton.disabled = !micPermisoConcedido; hablar(textoParaHablar); }
    function limpiarTextoCliente(texto = '') { if(typeof texto !== 'string') texto = String(texto); return texto.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
    function verificarRespuestaVoz(respuestaUsuario) { if (!socket || !socket.connected) { console.warn("Verificar Voz: No conectado"); return; } if(micButton) micButton.disabled = true; console.log(`Sending answer (Voz): "${respuestaUsuario}"`); socket.emit('submitAnswer', { gameInstanceId: gameInstanceId, userId: localUserId, answer: respuestaUsuario }); if(feedbackTextEl) { feedbackTextEl.textContent = '🤔 Comprobando...'; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center feedback-neutro'; } }
    function salirDelJuego() { console.log("Intentando salir..."); stopRecognition(true); if(btnSalirEl) btnSalirEl.disabled = true; if(btnSalirEl) btnSalirEl.innerText = "Saliendo..."; if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); } setTimeout(() => { window.location.href = '../menu.html'; }, 300); }
    function conectarSocket() { if (socket && socket.connected) return; if(jugadorActualEl) jugadorActualEl.innerText = "Conectando..."; socket = io(SOCKET_URL, { reconnectionAttempts: 3, timeout: 10000 }); socket.on("connect", () => { console.log("Socket Conectado:", socket.id); if(jugadorActualEl) jugadorActualEl.innerText = 'Conectado. Identificando...'; if (localUserId) { socket.emit("identify", localUserId); } else { console.error("localUserId no def"); alert("Error: Falta ID usr."); if(jugadorActualEl) jugadorActualEl.innerText = 'Error: Sin ID'; if(btnSalirEl) btnSalirEl.disabled = false; } }); socket.on("identified", () => { console.log("Identificado."); if(jugadorActualEl) jugadorActualEl.innerText = 'Identificado. Uniéndose...'; socket.emit('joinGame', { gameInstanceId: gameInstanceId, userId: localUserId, gameType: gameType }); }); socket.on("disconnect", (reason) => { console.warn("Socket Desc:", reason); if(jugadorActualEl) jugadorActualEl.innerText = 'Desconectado.'; alert("Se perdió conexión."); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; stopRecognition(true); if(micButton) micButton.disabled = true; }); socket.on("connect_error", (err) => { console.error("Error Conex Socket:", err.message); if(jugadorActualEl) jugadorActualEl.innerText = 'Error conexión.'; alert(`No se pudo conectar: ${err.message}.`); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; if(micButton) micButton.disabled = true; }); socket.on("serverError", (data) => { console.error("Error Servidor:", data.message); alert(`Error: ${data.message}`); stopRecognition(true); if(micButton) micButton.disabled = !micPermisoConcedido; }); socket.on("gameStateUpdate", (data) => { console.log("Rec gameStateUpdate:", data); try { actualizarUIJugadores(data.players || []); } catch(e) { console.error("Error update UI:", e)} }); socket.on("nextElement", (data) => { console.log("Rec nextElement (Voz):", data); try { if (data && data.element !== undefined) { mostrarDesafioVoz(data.element); } else { if(palabraADecirEl) palabraADecirEl.textContent = "Esperando desafío..."; stopRecognition(true); if(micButton) micButton.disabled=true; console.warn("Datos nextElement inc:", data); } } catch (e) { console.error("Error proc nextElement:", e); if(palabraADecirEl) palabraADecirEl.textContent = "Error al cargar"; } }); socket.on("feedbackUpdate", (data) => { console.log("Rec feedbackUpdate:", data); let feedbackMsg = ''; if (data.nivelCambiado) { try { if(sonidoNivel) sonidoNivel.play().catch(e=>{}); } catch(e){} feedbackMsg = `¡Nivel ${data.nuevoNivel}! `; if(nivelEl) nivelEl.innerText = data.nuevoNivel; } if (data.type >= 0.8) feedbackMsg += "🚀 Genial!"; else if (data.type >= 0.4) feedbackMsg += "👍 Bien!"; else feedbackMsg += "💪 Ánimo!"; if(feedbackTextEl) feedbackTextEl.textContent = feedbackMsg; actualizarMensajeMascota(data.type, data.nivelCambiado ? `¡Nivel ${data.nuevoNivel}!` : ''); }); socket.on("answerResult", (data) => { console.log("Rec answerResult:", data); if (data.userId === localUserId) { const esCorrecto = data.correct; mostrarFeedbackVisual(esCorrecto, data.expected); try { if(esCorrecto){ if(sonidoAcierto) sonidoAcierto.play().catch(e=>{});} else { if(sonidoError) sonidoError.play().catch(e=>{});} } catch(e){} if(aciertosEl) aciertosEl.innerText = data.totalAciertosJuego !== undefined ? data.totalAciertosJuego : '?'; if(micButton) micButton.disabled = !micPermisoConcedido; } else { console.log(`Jugador ${data.userId} respondió.`); } }); socket.on("playerLeft", (data) => { console.log(`Jugador ${data.userId} salió.`); if(estadoJugadoresEl) estadoJugadoresEl.innerText += ` (${data.userId} salió)`; }); socket.on("gameOver", (data) => { console.log("Game Over:", data.message); if(palabraADecirEl) palabraADecirEl.textContent = "¡Juego Terminado!"; if(resultadoVozEl) resultadoVozEl.textContent = ''; stopRecognition(true); if(micButton) micButton.disabled = true; if(feedbackTextEl) feedbackTextEl.textContent = data.message || '¡Muy bien!'; try { hablar(data.message || "Juego terminado"); } catch(e){} }); }
    window.addEventListener('load', async () => { if (!localUserId) { alert("Perfil no seleccionado. Volviendo inicio."); window.location.href = '../index.html'; return; } if (!gameInstanceId) { alert("Falta ID juego. Volviendo menú."); window.location.href = '../menu.html'; return; } if (!jugadorActualEl || !palabraADecirEl || !micButton || !resultadoVozEl || !feedbackTextEl || !btnSalirEl || !mascotaJuegoEl || !mensajeMascotaEl || !juegoAreaEl || !nivelEl || !aciertosEl || !estadoJugadoresEl || !sonidoAcierto || !sonidoError || !sonidoNivel || !sonidoMicOn || !sonidoMicOff ) { console.error("Error crítico: Faltan elementos HTML esenciales."); alert("Error al cargar la interfaz del juego."); return; } if (!SpeechRecognition) { if(micButton) micButton.textContent = "⛔ No Soportado"; if(micButton) micButton.disabled = true; alert("Reconocimiento de voz no soportado."); } else { await pedirPermisoMic(); } conectarSocket(); }); window.addEventListener('beforeunload', () => { stopRecognition(true); if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); socket.disconnect(); } });
</script>
</body>
</html>