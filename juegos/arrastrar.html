<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <title>🧩 Juego de Arrastrar (Sockets)</title> <script src="https://cdn.tailwindcss.com"></script> <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet"> <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style> body { font-family: 'Comic Neue', cursive; } .letra-draggable { cursor: grab; padding: 1rem 1.25rem; background-color: #facc15; border-radius: 0.75rem; font-size: 2rem; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: transform 0.2s, background-color 0.2s; user-select: none; display: inline-block; margin: 0.25rem; } .letra-draggable:hover { background-color: #fbbf24; transform: scale(1.1); } .letra-draggable[draggable="false"] { cursor: default; opacity: 0.7; } .letra-soltada { background-color: #a7f3d0 !important; cursor: default !important; } .zona-drop { border: 3px dashed #94a3b8; min-height: 80px; width: 90%; max-width: 450px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; padding: 1rem; margin: 1rem auto; background-color: #f8fafc; border-radius: 1rem; font-size: 2rem; font-weight: bold; color: #334155; transition: background-color 0.3s; } .zona-drop.drag-over { background-color: #e2e8f0; border-style: solid; border-color: #60a5fa; } .feedback-positivo { color: #16a34a; } .feedback-negativo { color: #dc2626; } button:disabled { opacity: 0.6; cursor: not-allowed; } iframe { margin: 1.5rem auto; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: block; max-width: 90%; } </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-yellow-100 to-orange-200 text-center p-6">
    <h1 class="text-4xl font-bold text-yellow-800 mb-4">🧩 Juego de Arrastrar</h1>
    <div class="flex justify-center items-center gap-4 mb-4"> <img id="mascota-juego" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" alt="Mascota" class="w-20 h-20 animate-bounce"> <div> <p id="jugador-actual" class="text-lg font-bold text-purple-800">Cargando...</p> <p id="mensaje-mascota" class="text-md text-purple-600 font-semibold">¡Ordena las letras!</p> </div> </div> <div id="estado-jugadores" class="text-sm text-gray-600 mb-4 h-6"></div>
    <iframe width="320" height="240" src="https://www.youtube.com/embed/yv8YpgZgg9E" title="Video instructivo Arrastrar" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    <div id="juego-area" class="bg-white max-w-2xl mx-auto p-6 rounded-xl shadow mb-6 opacity-50 transition-opacity duration-500">
         <!-- Etiqueta corregida -->
        <p class="text-lg text-gray-700">Nivel (Arrastrar): <span id="nivel" class="font-bold">?</span> | Aciertos (Arrastrar): <span id="aciertos" class="font-bold">?</span></p>
        <p class="text-xl font-semibold my-4">Forma esta palabra/sílaba:</p>
        <div id="objetivo-display" class="text-3xl font-bold text-yellow-700 mb-4 min-h-[3rem] tracking-widest">Esperando...</div>
        <p class="text-sm text-gray-600 mb-2">Arrastra las letras aquí:</p>
        <div class="zona-drop" id="zona-drop" ondrop="soltar(event)" ondragover="permitirDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
        <button onclick="borrarIntento()" id="btn-limpiar" class="mt-3 mb-4 bg-orange-500 hover:bg-orange-600 text-white px-4 py-1 rounded-full shadow text-sm disabled:opacity-50" disabled>🧹 Limpiar</button>
        <p class="text-sm text-gray-600 mt-4 mb-2">Letras disponibles:</p>
        <div id="letras-drag" class="flex flex-wrap justify-center gap-2 min-h-[4rem]"></div>
        <div id="feedback" class="text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center"> <span id="feedback-text"></span> </div>
    </div>
    <div class="mt-8 space-x-4"> <button id="btn-salir" onclick="salirDelJuego()" class="bg-red-500 hover:bg-red-700 text-white px-5 py-2 rounded-full shadow transition transform hover:scale-105 disabled:opacity-50" disabled>🚪 Salir</button> <a href="../menu.html" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2.5 rounded-full inline-block">🔙 Volver al Menú</a> </div>
    <audio id="sonido-acierto" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio> <audio id="sonido-error" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio> <audio id="sonido-nivel" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>
<script>
    const SOCKET_URL = "http://localhost:3001"; const localUserId = parseInt(localStorage.getItem("usuarioActivo")); const urlParams = new URLSearchParams(window.location.search); const gameInstanceId = urlParams.get('gameId'); const gameType = 'arrastrar'; let socket; let miNombre = ''; let miMascota = ''; let objetivoActual = ''; let letrasEnDropZone = []; let dragSourceElement = null; let nivelActualLocal = 1; let aciertosJuegoLocal = 0; const jugadorActualEl = document.getElementById('jugador-actual'); const estadoJugadoresEl = document.getElementById('estado-jugadores'); const mascotaJuegoEl = document.getElementById('mascota-juego'); const mensajeMascotaEl = document.getElementById('mensaje-mascota'); const juegoAreaEl = document.getElementById('juego-area'); const nivelEl = document.getElementById('nivel'); const aciertosEl = document.getElementById('aciertos'); const objetivoDisplayEl = document.getElementById('objetivo-display'); const zonaDropEl = document.getElementById('zona-drop'); const letrasDragEl = document.getElementById('letras-drag'); const feedbackTextEl = document.getElementById('feedback-text'); const btnSalirEl = document.getElementById('btn-salir'); const btnLimpiarEl = document.getElementById('btn-limpiar'); const sonidoAcierto = document.getElementById('sonido-acierto'); const sonidoError = document.getElementById('sonido-error'); const sonidoNivel = document.getElementById('sonido-nivel'); const frasesMascota = { "Perro": "¡Ordena las letras! 🐶", "Gato": "¡Concéntrate! 🐱", "Tortuga": "¡Letra por letra! 🐢", "Elefante": "¡Tú puedes! 🐘" }; const imagenesMascotas = { "Perro": "https://cdn-icons-png.flaticon.com/512/616/616408.png", "Gato": "https://cdn-icons-png.flaticon.com/512/616/616430.png", "Tortuga": "https://cdn-icons-png.flaticon.com/512/1998/1998611.png", "Elefante": "https://cdn-icons-png.flaticon.com/512/616/6164089.png"};
    function hablar(texto) { if (!texto || typeof speechSynthesis === 'undefined') return; try { speechSynthesis.cancel(); const voz = new SpeechSynthesisUtterance(texto); voz.lang = 'es-ES'; voz.rate = 1.1; speechSynthesis.speak(voz); } catch(e){ console.error("Speech error:", e); } }
    function actualizarMensajeMascota(tipo, textoAdicional = '') { let mensajeBase = frasesMascota[miMascota] || "¡Sigue así!"; if (mensajeMascotaEl) mensajeMascotaEl.innerText = mensajeBase + " " + textoAdicional; }
    function actualizarUIJugadores(playersData) { let jugadoresHtml = 'Jugando: '; let foundMe = false; if(!playersData || playersData.length === 0) { if(estadoJugadoresEl) estadoJugadoresEl.innerText = 'Esperando jugadores...'; return; } playersData.forEach(p => { const nivelToShow = (p.nivel !== undefined && p.nivel !== null) ? p.nivel : '?'; const aciertosToShow = (p.totalAciertosJuego !== undefined && p.totalAciertosJuego !== null) ? p.totalAciertosJuego : '?'; jugadoresHtml += `${p.nombre}(N${nivelToShow})${p.userId === localUserId ? '⭐' : ''}, `; if (p.userId === localUserId) { foundMe = true; miNombre = p.nombre; miMascota = p.mascota; nivelActualLocal = nivelToShow; aciertosJuegoLocal = aciertosToShow; if(jugadorActualEl) jugadorActualEl.innerText = `¡Vamos ${miNombre}!`; if(nivelEl) nivelEl.innerText = nivelToShow; if(aciertosEl) aciertosEl.innerText = aciertosToShow; // ** USA ACIERTOS DEL JUEGO **
         try{ if(mascotaJuegoEl) mascotaJuegoEl.src = imagenesMascotas[p.mascota] || imagenesMascotas['Perro']; } catch(e){console.error("Err mascot", e)} } }); if (!foundMe) { if(jugadorActualEl) jugadorActualEl.innerText = "Esperando..."; } if(estadoJugadoresEl) estadoJugadoresEl.innerText = jugadoresHtml.slice(0, -2); if(juegoAreaEl) juegoAreaEl.style.opacity = 1; if(btnSalirEl) btnSalirEl.disabled = false; }
    function mostrarFeedbackVisual(esCorrecto, textoExpected = null) { let textoPrevio = feedbackTextEl?.textContent || ''; let mensajePrincipal = esCorrecto ? `✅ ¡Correcto!` : `❌ ¡Ups!`; if (!esCorrecto && textoExpected) { mensajePrincipal += ` Era "${textoExpected}".`; } if(feedbackTextEl) { feedbackTextEl.textContent = `${mensajePrincipal} ${textoPrevio}`; feedbackTextEl.className = `text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center ${esCorrecto ? 'feedback-positivo' : 'feedback-negativo'}`; } if(btnLimpiarEl) btnLimpiarEl.disabled = true; letrasDragEl.querySelectorAll('span').forEach(s => s.setAttribute('draggable', 'false')); zonaDropEl.querySelectorAll('span').forEach(s => s.classList.add('cursor-default'));}
    function dragStart(e) { if (!e.target.getAttribute('draggable') || e.target.getAttribute('draggable') === 'false') { e.preventDefault(); return; } dragSourceElement = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', e.target.textContent); setTimeout(() => { if(e.target && e.target.classList) e.target.classList.add('opacity-50') }, 0); }
    function dragEnd(e) { if(e && e.target && e.target.classList) { e.target.classList.remove('opacity-50'); } }
    function permitirDrop(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
    function dragEnter(e) { e.preventDefault(); if (e.target === zonaDropEl) zonaDropEl.classList.add('drag-over'); }
    function dragLeave(e) { if (e.target === zonaDropEl) zonaDropEl.classList.remove('drag-over'); }
    function soltar(e) { e.preventDefault(); zonaDropEl.classList.remove('drag-over'); if (!dragSourceElement || dragSourceElement.parentNode !== letrasDragEl || dragSourceElement.style.display === 'none') { dragSourceElement = null; return; } const letra = e.dataTransfer.getData('text/plain'); if (letra) { const spanSoltado = document.createElement('span'); spanSoltado.className = 'letra-draggable letra-soltada mx-1 cursor-default'; spanSoltado.textContent = letra; spanSoltado.dataset.sourceId = dragSourceElement.id; zonaDropEl.appendChild(spanSoltado); letrasEnDropZone.push(letra); dragSourceElement.style.display = 'none'; dragSourceElement.setAttribute('draggable', 'false'); dragSourceElement = null; const respuestaFormada = letrasEnDropZone.join(''); if (limpiarTextoCliente(respuestaFormada) === limpiarTextoCliente(objetivoActual)) { verificar(respuestaFormada); } } else { dragSourceElement = null; } }
    function mostrarDesafioArrastrar(elemento, challengeData) { console.log("Mostrar Desafio (Arrastrar):", elemento, challengeData); objetivoActual = elemento; if(objetivoDisplayEl) objetivoDisplayEl.textContent = elemento; borrarIntento(); if(letrasDragEl) letrasDragEl.innerHTML = ''; if (challengeData && challengeData.shuffledLetters) { challengeData.shuffledLetters.forEach((letra, index) => { const span = document.createElement('span'); span.id = `letra-drag-${index}`; span.className = 'letra-draggable'; span.textContent = letra; span.setAttribute('draggable', 'true'); span.style.display = 'inline-block'; span.addEventListener('dragstart', dragStart); span.addEventListener('dragend', dragEnd); if(letrasDragEl) letrasDragEl.appendChild(span); }); } else { if(letrasDragEl) letrasDragEl.innerHTML = '<p class="text-gray-500">Error: Faltan letras.</p>'; console.error("No se recibieron letras desordenadas"); } if(feedbackTextEl) { feedbackTextEl.textContent = ''; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center'; } if(btnLimpiarEl) btnLimpiarEl.disabled = false; hablar(`Forma la palabra ${elemento}`); }
    function borrarIntento() { if(zonaDropEl) zonaDropEl.innerHTML = ''; letrasEnDropZone = []; letrasDragEl.querySelectorAll('span').forEach(span => { span.style.display = 'inline-block'; span.setAttribute('draggable', 'true'); }); if(feedbackTextEl) feedbackTextEl.textContent = ''; }
    function limpiarTextoCliente(texto = '') { if(typeof texto !== 'string') texto = String(texto); return texto.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
    function verificar(respuestaFormada) { console.log(`Sending answer (Arrastrar): ${respuestaFormada}`); socket.emit('submitAnswer', { gameInstanceId: gameInstanceId, userId: localUserId, answer: respuestaFormada }); mostrarFeedbackVisual(true); if(btnLimpiarEl) btnLimpiarEl.disabled = true; letrasDragEl.querySelectorAll('span').forEach(s => s.setAttribute('draggable','false')); zonaDropEl.querySelectorAll('span').forEach(s => s.classList.add('cursor-default')); }
    function salirDelJuego() { console.log("Intentando salir..."); if(btnSalirEl) btnSalirEl.disabled = true; if(btnSalirEl) btnSalirEl.innerText = "Saliendo..."; if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); } setTimeout(() => { window.location.href = '../menu.html'; }, 300); }
    function conectarSocket() { if (socket && socket.connected) return; if(jugadorActualEl) jugadorActualEl.innerText = "Conectando..."; socket = io(SOCKET_URL, { reconnectionAttempts: 3, timeout: 10000 }); socket.on("connect", () => { console.log("Socket Conectado:", socket.id); if(jugadorActualEl) jugadorActualEl.innerText = 'Conectado. Identificando...'; if (localUserId) { socket.emit("identify", localUserId); } else { console.error("localUserId no def"); alert("Error: Falta ID usr."); if(jugadorActualEl) jugadorActualEl.innerText = 'Error: Sin ID'; if(btnSalirEl) btnSalirEl.disabled = false; } }); socket.on("identified", () => { console.log("Identificado."); if(jugadorActualEl) jugadorActualEl.innerText = 'Identificado. Uniéndose...'; socket.emit('joinGame', { gameInstanceId: gameInstanceId, userId: localUserId, gameType: gameType }); }); socket.on("disconnect", (reason) => { console.warn("Socket Desc:", reason); if(jugadorActualEl) jugadorActualEl.innerText = 'Desconectado.'; alert("Se perdió conexión."); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; if(objetivoDisplayEl) objetivoDisplayEl.textContent = "Desconectado"; if(zonaDropEl) zonaDropEl.innerHTML = ''; if(letrasDragEl) letrasDragEl.innerHTML = ''; if(btnLimpiarEl) btnLimpiarEl.disabled = true; }); socket.on("connect_error", (err) => { console.error("Error Conex Socket:", err.message); if(jugadorActualEl) jugadorActualEl.innerText = 'Error conexión.'; alert(`No se pudo conectar: ${err.message}.`); if(juegoAreaEl) juegoAreaEl.style.opacity = 0.5; if(btnSalirEl) btnSalirEl.disabled = true; if(btnLimpiarEl) btnLimpiarEl.disabled = true;}); socket.on("serverError", (data) => { console.error("Error Servidor:", data.message); alert(`Error: ${data.message}`); if(feedbackTextEl) { feedbackTextEl.textContent = `⚠️ ${data.message}`; feedbackTextEl.className = 'text-xl font-semibold min-h-[3rem] mt-4 flex items-center justify-center feedback-negativo';} }); socket.on("gameStateUpdate", (data) => { console.log("Rec gameStateUpdate:", data); try { actualizarUIJugadores(data.players || []); } catch(e) { console.error("Error update UI:", e)} }); socket.on("nextElement", (data) => { console.log("Recibido nextElement (Arrastrar):", data); try { if (data && data.element && data.challengeData && Array.isArray(data.challengeData.shuffledLetters)) { mostrarDesafioArrastrar(data.element, data.challengeData); } else { if(objetivoDisplayEl) objetivoDisplayEl.textContent = "Esperando desafío..."; if(letrasDragEl) letrasDragEl.innerHTML = ''; console.warn("Datos de nextElement incompletos o inválidos:", data); } } catch (e) { console.error("Error procesando nextElement:", e); if(objetivoDisplayEl) objetivoDisplayEl.textContent = "Error al cargar"; } }); socket.on("feedbackUpdate", (data) => { console.log("Rec feedbackUpdate:", data); let feedbackMsg = ''; if (data.nivelCambiado) { try { if(sonidoNivel) sonidoNivel.play().catch(e=>{console.warn("Sound error",e)}); } catch(e){} feedbackMsg = `¡Nivel ${data.nuevoNivel}! `; if(nivelEl) nivelEl.innerText = data.nuevoNivel; } if (data.type >= 0.8) feedbackMsg += "🚀 ¡Genial!"; else if (data.type >= 0.4) feedbackMsg += "👍 ¡Bien!"; else feedbackMsg += "💪 ¡Ánimo!"; if(feedbackTextEl) feedbackTextEl.textContent = feedbackMsg; actualizarMensajeMascota(data.type, data.nivelCambiado ? `¡Nivel ${data.nuevoNivel}!` : ''); }); socket.on("answerResult", (data) => { console.log("Recibido answerResult:", data); if (data.userId === localUserId) { const esCorrectoServer = data.correct; mostrarFeedbackVisual(esCorrectoServer, data.expected); try { if (esCorrectoServer) { if(sonidoAcierto) sonidoAcierto.play().catch(e=>{console.warn("Sound error",e)}); } else { if(sonidoError) sonidoError.play().catch(e=>{console.warn("Sound error",e)}); borrarIntento(); } } catch(e){} if(aciertosEl) aciertosEl.innerText = data.totalAciertosJuego !== undefined ? data.totalAciertosJuego : '?'; // ** USA ACIERTOS DEL JUEGO **
         } else { console.log(`Jugador ${data.userId} respondió.`); } }); socket.on("playerLeft", (data) => { console.log(`Jugador ${data.userId} salió.`); if(estadoJugadoresEl) estadoJugadoresEl.innerText += ` (${data.userId} salió)`; }); socket.on("gameOver", (data) => { console.log("Game Over:", data.message); if(objetivoDisplayEl) objetivoDisplayEl.textContent = "¡Juego Terminado!"; if(letrasDragEl) letrasDragEl.innerHTML = `<p class="text-lg font-semibold">${data.message || '¡Muy bien!'}</p>`; if(zonaDropEl) zonaDropEl.innerHTML = ''; if(feedbackTextEl) feedbackTextEl.textContent = ''; if(btnLimpiarEl) btnLimpiarEl.disabled = true; try { hablar(data.message || "Juego terminado"); } catch(e){} }); }
    window.addEventListener('load', () => { if (!localUserId) { alert("Perfil no seleccionado. Volviendo inicio."); window.location.href = '../index.html'; return; } if (!gameInstanceId) { alert("Falta ID juego. Volviendo menú."); window.location.href = '../menu.html'; return; } if (!jugadorActualEl || !objetivoDisplayEl || !zonaDropEl || !letrasDragEl || !btnLimpiarEl || !feedbackTextEl || !btnSalirEl || !mascotaJuegoEl || !mensajeMascotaEl || !juegoAreaEl || !nivelEl || !aciertosEl || !estadoJugadoresEl || !sonidoAcierto || !sonidoError || !sonidoNivel) { console.error("Error crítico: Faltan elementos HTML esenciales."); alert("Error al cargar la interfaz del juego."); return; } conectarSocket(); }); window.addEventListener('beforeunload', () => { if (socket && socket.connected) { socket.emit('leaveGame', { gameInstanceId: gameInstanceId, userId: localUserId }); socket.disconnect(); } });
</script>
</body>
</html>